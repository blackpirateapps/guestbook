<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackPiratex(Sudip) 's Guestbook</title>
    <!-- Using Pico.css for styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body>

    <main class="container">
        <header class="text-center" style="text-align: center; margin-bottom: 2rem;">
            <h1>BlackPiratex(Sudip) 's Guestbook</h1>
            <p>Sign my guestbook xx</p>
        </header>

        <!-- Guestbook Form -->
        <article>
            <form id="guestbook-form" name="guestbook" netlify netlify-honeypot="bot-field">
                <p style="display: none;">
                    <label>Don’t fill this out if you’re human: <input name="bot-field" /></label>
                </p>
                <input type="hidden" name="form-name" value="guestbook">

                <label for="name">Your Name:</label>
                <input type="text" id="name" name="name" required placeholder="Jane Doe">

                <label for="message">Your Message:</label>
                <textarea id="message" name="message" rows="4" required placeholder="Hello world!"></textarea>

                <label for="website">Your Website (Optional):</label>
                <input type="url" id="website" name="website" placeholder="https://example.com">

                <!-- Bot Verification -->
                <label for="verification">
                    Bot Verification: <span id="math-problem" style="font-weight: bold;"></span>
                </label>
                <input type="number" id="verification" name="verification" required placeholder="?" style="width: 100px;">
                
                <button type="submit" id="submit-button">Sign Guestbook</button>
            </form>
            <div id="success-message" hidden role="alert" style="background-color: #d4edda; color: #155724; padding: 1rem; margin-top: 1rem; border-radius: 0.25rem;">
                <strong>Thank you!</strong> Your message has been submitted.
            </div>
             <div id="error-message" hidden role="alert" style="background-color: #f8d7da; color: #721c24; padding: 1rem; margin-top: 1rem; border-radius: 0.25rem;">
                <strong id="error-text"></strong>
            </div>
        </article>

        <!-- Guestbook Entries -->
        <section id="guestbook-entries-container" style="margin-top: 3rem;">
            <h2 style="text-align: center;">Entries</h2>
            <div id="loading" style="text-align: center;">
                <p><progress></progress><br/>Loading guestbook entries...</p>
            </div>
            <!-- Entries will be dynamically inserted here -->
        </section>

    </main>

    <script>
        const guestbookEntriesContainer = document.getElementById('guestbook-entries-container');
        const loadingIndicator = document.getElementById('loading');
        const guestbookForm = document.getElementById('guestbook-form');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const submitButton = document.getElementById('submit-button');

        let num1, num2, correctAnswer;

        const generateMathProblem = () => {
            num1 = Math.floor(Math.random() * 10) + 1;
            num2 = Math.floor(Math.random() * 10) + 1;
            correctAnswer = num1 + num2;
            document.getElementById('math-problem').textContent = `What is ${num1} + ${num2}?`;
        };

        const fetchGuestbookEntries = async () => {
            loadingIndicator.style.display = 'block';
            const existingEntries = guestbookEntriesContainer.querySelectorAll('article');
            existingEntries.forEach(e => e.remove());

            try {
                const response = await fetch('/.netlify/functions/get-entries');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'An unknown error occurred.' }));
                    throw new Error(errorData.error || `Function Error: ${response.statusText}`);
                }
                const submissions = await response.json();

                if (submissions.length === 0) {
                    loadingIndicator.innerHTML = '<p>No entries yet. Be the first to sign!</p>';
                } else {
                    loadingIndicator.style.display = 'none';
                }

                submissions.forEach(submission => {
                    const entryArticle = document.createElement('article');
                    
                    const header = document.createElement('header');
                    const nameElement = document.createElement('strong');
                    nameElement.textContent = submission.name || 'Anonymous';
                    header.appendChild(nameElement);

                    // --- MODIFIED SECTION START ---
                    // If a website is submitted, create a clickable link next to the name
                    if (submission.website) {
                        const websiteElement = document.createElement('a');
                        let url = submission.website;
                        if (!/^https?:\/\//i.test(url)) {
                            url = 'https://' + url;
                        }
                        websiteElement.href = url;
                        // Display the actual submitted URL as the link text
                        websiteElement.textContent = `(${submission.website})`;
                        websiteElement.target = '_blank';
                        websiteElement.rel = 'noopener noreferrer';
                        websiteElement.style.marginLeft = '0.5rem';
                        websiteElement.style.fontSize = '0.9em';
                        header.appendChild(websiteElement);
                    }
                    // --- MODIFIED SECTION END ---

                    const messageElement = document.createElement('p');
                    messageElement.textContent = submission.message || '';
                    
                    const footer = document.createElement('footer');
                    footer.style.textAlign = 'right';
                    footer.style.fontSize = '0.8em';
                    footer.textContent = new Date(submission.date).toLocaleString();

                    entryArticle.appendChild(header);
                    entryArticle.appendChild(messageElement);
                    entryArticle.appendChild(footer);
                    guestbookEntriesContainer.appendChild(entryArticle);
                });

            } catch (error) {
                console.error('Error fetching guestbook entries:', error);
                loadingIndicator.innerHTML = `<p style="color: #721c24;">Could not load guestbook entries. This can happen if the site hasn't been configured yet. Please check the setup instructions.</p>`;
            }
        };

        guestbookForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            successMessage.hidden = true;
            errorMessage.hidden = true;

            const userAnswer = parseInt(document.getElementById('verification').value, 10);
            if (userAnswer !== correctAnswer) {
                errorText.textContent = 'Incorrect answer to the math problem. Please try again.';
                errorMessage.hidden = false;
                generateMathProblem();
                document.getElementById('verification').value = '';
                return;
            }

            const formData = new FormData(guestbookForm);
            submitButton.setAttribute('aria-busy', 'true');
            submitButton.disabled = true;

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(formData).toString()
                });

                if (response.ok) {
                    successMessage.hidden = false;
                    guestbookForm.reset();
                    generateMathProblem();
                    setTimeout(fetchGuestbookEntries, 1000);
                } else {
                     throw new Error('Form submission failed.');
                }
            } catch (error) {
                console.error('Form submission error:', error);
                errorText.textContent = 'There was an error submitting your message. Please try again.';
                errorMessage.hidden = false;
            } finally {
                submitButton.setAttribute('aria-busy', 'false');
                submitButton.disabled = false;
            }
        });

        window.onload = () => {
            generateMathProblem();
            fetchGuestbookEntries();
        };
    </script>
</body>
</html>
