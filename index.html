<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackPiratex(Sudip) 's Guestbook</title>
    <!-- Minimal, embedded CSS -->
    <style>
        :root {
            --primary-color: #007bff;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #212529;
            --muted-text-color: #6c757d;
            --border-color: #dee2e6;
            --success-bg: #d1e7dd;
            --success-color: #0f5132;
            --error-bg: #f8d7da;
            --error-color: #842029;
            --border-radius: 0.5rem;
            --box-shadow: 0 2px 4px rgba(0,0,0,0.075);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        main.container {
            max-width: 720px;
            margin: 1rem auto;
        }
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        header h1 {
            margin-bottom: 0.5rem;
        }
        article {
            background-color: var(--card-background);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }
        input[type="text"],
        input[type="url"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box; /* Important for consistent sizing */
        }
        button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background-color: var(--muted-text-color);
            cursor: not-allowed;
        }
        .alert {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
        }
        .alert-success {
            background-color: var(--success-bg);
            color: var(--success-color);
        }
        .alert-error {
            background-color: var(--error-bg);
            color: var(--error-color);
        }
        #guestbook-entries-container article {
            margin-top: 1rem;
        }
        #guestbook-entries-container header {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            font-size: 1.1rem;
        }
        #guestbook-entries-container footer {
            text-align: right;
            font-size: 0.85rem;
            color: var(--muted-text-color);
            margin-top: 1rem;
        }
        a {
            color: var(--primary-color);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <main class="container">
        <header>
            <h1>BlackPiratex(Sudip) 's Guestbook</h1>
            <p>Sign my guestbook xx</p>
        </header>

        <!-- Guestbook Form -->
        <article>
            <form id="guestbook-form" name="guestbook-v2" netlify netlify-honeypot="bot-field">
                <p style="display: none;">
                    <label>Don’t fill this out if you’re human: <input name="bot-field" /></label>
                </p>
                <input type="hidden" name="form-name" value="guestbook-v2">

                <label for="name">Your Name:</label>
                <input type="text" id="name" name="name" required placeholder="Jane Doe">

                <label for="message">Your Message:</label>
                <textarea id="message" name="message" rows="4" required placeholder="Hello world!"></textarea>

                <label for="website">Your Website (Optional):</label>
                <input type="url" id="website" name="website" placeholder="https://example.com">

                <label for="verification">
                    Bot Verification: <span id="math-problem" style="font-weight: bold;"></span>
                </label>
                <input type="number" id="verification" name="verification" required placeholder="?" style="width: 100px;">
                
                <button type="submit" id="submit-button">Sign Guestbook</button>
            </form>
            <div id="success-message" class="alert alert-success" hidden role="alert">
                <strong>Thank you!</strong> Your message has been submitted.
            </div>
             <div id="error-message" class="alert alert-error" hidden role="alert">
                <strong id="error-text"></strong>
            </div>
        </article>

        <!-- Guestbook Entries -->
        <section id="guestbook-entries-container" style="margin-top: 3rem;">
            <h2 style="text-align: center;">Entries</h2>
            <div id="loading" style="text-align: center;">
                <p>Loading guestbook entries...</p>
            </div>
            <!-- Entries will be dynamically inserted here -->
        </section>

    </main>

    <script>
        const guestbookEntriesContainer = document.getElementById('guestbook-entries-container');
        const loadingIndicator = document.getElementById('loading');
        const guestbookForm = document.getElementById('guestbook-form');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const submitButton = document.getElementById('submit-button');

        let num1, num2, correctAnswer;

        const generateMathProblem = () => {
            num1 = Math.floor(Math.random() * 10) + 1;
            num2 = Math.floor(Math.random() * 10) + 1;
            correctAnswer = num1 + num2;
            document.getElementById('math-problem').textContent = `What is ${num1} + ${num2}?`;
        };

        const fetchGuestbookEntries = async () => {
            loadingIndicator.style.display = 'block';
            const existingEntries = guestbookEntriesContainer.querySelectorAll('article');
            existingEntries.forEach(e => e.remove());

            try {
                const response = await fetch('/.netlify/functions/get-entries');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'An unknown error occurred.' }));
                    throw new Error(errorData.error || `Function Error: ${response.statusText}`);
                }
                const submissions = await response.json();

                if (submissions.length === 0) {
                    loadingIndicator.innerHTML = '<p>No entries yet. Be the first to sign!</p>';
                } else {
                    loadingIndicator.style.display = 'none';
                }

                submissions.forEach(submission => {
                    const entryArticle = document.createElement('article');
                    
                    const header = document.createElement('header');
                    const nameElement = document.createElement('strong');
                    nameElement.textContent = submission.name || 'Anonymous';
                    header.appendChild(nameElement);

                    if (submission.website) {
                        const websiteElement = document.createElement('a');
                        let url = submission.website;
                        if (!/^https?:\/\//i.test(url)) {
                            url = 'https://' + url;
                        }
                        websiteElement.href = url;
                        websiteElement.textContent = `(${submission.website})`;
                        websiteElement.target = '_blank';
                        websiteElement.rel = 'noopener noreferrer';
                        websiteElement.style.fontSize = '0.9em';
                        header.appendChild(websiteElement);
                    }

                    const messageElement = document.createElement('p');
                    messageElement.textContent = submission.message || '';
                    
                    const footer = document.createElement('footer');
                    footer.textContent = new Date(submission.date).toLocaleString();

                    entryArticle.appendChild(header);
                    entryArticle.appendChild(messageElement);
                    entryArticle.appendChild(footer);
                    guestbookEntriesContainer.appendChild(entryArticle);
                });

            } catch (error) {
                console.error('Error fetching guestbook entries:', error);
                loadingIndicator.innerHTML = `<p style="color: var(--error-color);">Could not load guestbook entries. This can happen if the site hasn't been configured yet. Please check the setup instructions.</p>`;
            }
        };

        guestbookForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            successMessage.hidden = true;
            errorMessage.hidden = true;

            const userAnswer = parseInt(document.getElementById('verification').value, 10);
            if (userAnswer !== correctAnswer) {
                errorText.textContent = 'Incorrect answer to the math problem. Please try again.';
                errorMessage.hidden = false;
                generateMathProblem();
                document.getElementById('verification').value = '';
                return;
            }

            const formData = new FormData(guestbookForm);
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(formData).toString()
                });

                if (response.ok) {
                    successMessage.hidden = false;
                    guestbookForm.reset();
                    generateMathProblem();
                    setTimeout(fetchGuestbookEntries, 1000);
                } else {
                     throw new Error('Form submission failed.');
                }
            } catch (error) {
                console.error('Form submission error:', error);
                errorText.textContent = 'There was an error submitting your message. Please try again.';
                errorMessage.hidden = false;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Sign Guestbook';
            }
        });

        window.onload = () => {
            generateMathProblem();
            fetchGuestbookEntries();
        };
    </script>
</body>
</html>
